{"remainingRequest":"D:\\Projects\\spark\\Spark.UI\\node_modules\\babel-loader\\lib\\index.js!D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Projects\\spark\\Spark.UI\\src\\views\\xmgl\\htly\\ProjectStartManage\\edit.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Projects\\spark\\Spark.UI\\src\\views\\xmgl\\htly\\ProjectStartManage\\edit.vue","mtime":1633684104563},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["\"use strict\";\n\nvar _interopRequireDefault = require(\"D:/Projects/spark/Spark.UI/node_modules/@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _objectSpread2 = _interopRequireDefault(require(\"D:/Projects/spark/Spark.UI/node_modules/@babel/runtime/helpers/objectSpread2\"));\n\nrequire(\"core-js/modules/es6.function.name\");\n\nrequire(\"core-js/modules/es6.number.constructor\");\n\nvar _flowSelect = _interopRequireDefault(require(\"@/components/Flow/flowSelect\"));\n\nvar _project = require(\"@/api/xmgl/project.js\");\n\nvar _MyForm = _interopRequireDefault(require(\"@/components/MyForm\"));\n\nvar _ProjectStartManage = require(\"@/api/xmgl/ProjectStartManage.js\");\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nvar _default = {\n  name: 'ProjectStartManageEdit',\n  components: {\n    // Select,\n    FlowSelect: _flowSelect.default,\n    // UpFile,\n    // ProjectSelect,\n    MyForm: _MyForm.default\n  },\n  data: function data() {\n    return {\n      size: 'mini',\n      active: 1,\n      // 提交进度 1: 编辑信息 2: 编辑审批流程\n      firstForm: {\n        companyId: '',\n        // 公司id\n        projectId: '',\n        // 项目id\n        id: 0,\n        // 新增为0\n        number: '',\n        // 新增时,编号后端生成\n        orgId: '',\n        // 部门id\n        orgName: '',\n        // 部门名称\n        startDate: '',\n        // 开工日期\n        startType: 1,\n        // 开工类型\n        orderUnit: '',\n        // 指令单位\n        orderPeople: '',\n        // 指令人\n        contractDuration: '',\n        // 合同约定工期\n        computeFinishDate: '',\n        // 计算竣工日期\n        fileList: [],\n        // 附件\n        state: 0,\n        // 状态\n        billFlow: [],\n        // 单据流程\n        remark: ''\n      },\n      firstRules: {\n        projectId: [{\n          required: true,\n          message: '请选择项目',\n          trigger: 'change'\n        }],\n        startDate: [{\n          required: true,\n          message: '请选择实际开工日期',\n          trigger: 'change'\n        }],\n        startType: [{\n          required: true,\n          message: '请选择实际开工类型',\n          trigger: 'change'\n        }],\n        orderUnit: [{\n          required: true,\n          message: '请输入指令单位',\n          trigger: 'change'\n        }]\n      },\n      filter: {\n        orgList: [],\n        startTypeList: []\n      },\n      project: {}\n    };\n  },\n  computed: {\n    title: function title() {\n      var active = this.active;\n      return active === 2 ? '审批流程' : '项目开工';\n    },\n\n    /**\r\n     * 处理form表单的数据\r\n     */\n    formNodeData: function formNodeData() {\n      var startTypeList = this.filter.startTypeList;\n      return [{\n        label: '编码:',\n        monopolize: true,\n        keyword: 'number',\n        props: {\n          disabled: true,\n          placeholder: '系统自动生成'\n        }\n      }, {\n        label: '项目:',\n        keyword: 'projectId',\n        component: 'ProjectSelect',\n        props: {\n          projectState: [0]\n        }\n      }, {\n        label: '组织机构:',\n        keyword: 'orgName',\n        props: {\n          disabled: true,\n          placeholder: '请选择有项目的部门'\n        }\n      }, {\n        label: '实际开工日期:',\n        keyword: 'startDate',\n        component: 'el-date-picker',\n        props: {\n          placeholder: '请选择'\n        }\n      }, {\n        label: '开工类型:',\n        keyword: 'startType',\n        component: 'Select',\n        props: {\n          propsLabel: 'name',\n          options: startTypeList,\n          placeholder: '请选择'\n        }\n      }, {\n        label: '指令单位:',\n        keyword: 'orderUnit',\n        props: {\n          placeholder: '请输入'\n        }\n      }, {\n        label: '指令人:',\n        keyword: 'orderPeople',\n        props: {\n          placeholder: '请输入'\n        }\n      }, {\n        label: '合同约定工期:',\n        keyword: 'contractDuration',\n        props: {\n          disabled: true,\n          placeholder: '自动带出'\n        }\n      }, {\n        label: '计算竣工日期:',\n        keyword: 'computeFinishDate',\n        component: 'el-date-picker',\n        props: {\n          disabled: true,\n          placeholder: '自动计算'\n        }\n      }, {\n        label: '备注:',\n        keyword: 'remark',\n        monopolize: true,\n        props: {\n          type: 'textarea'\n        }\n      }, {\n        label: '附件:',\n        monopolize: true,\n        keyword: 'fileList',\n        component: 'UpFile',\n        width: '100%',\n        props: {\n          isUpfile: true,\n          isDelete: true\n        }\n      }];\n    }\n  },\n  watch: {\n    'firstForm': {\n      handler: function handler(nVal) {\n        var _this = this;\n\n        var contractDuration = nVal.contractDuration,\n            startDate = nVal.startDate;\n\n        var d = function d(dataStr) {\n          return dataStr ? _this.$moment(dataStr).format('YYYY-MM-DD') : dataStr;\n        };\n\n        var startTime = new Date(startDate).getTime();\n        var durationTime = (Number(contractDuration) || 0) * 24 * 60 * 60 * 1000;\n        this.firstForm.computeFinishDate = d(new Date(startTime + durationTime) || '');\n      },\n      deep: true\n    }\n  },\n  beforeRouteEnter: function beforeRouteEnter(to, from, next) {\n    next(function (vm) {\n      vm.initSelect();\n      var newId = vm.$route.query.id;\n      var oldId = vm.firstForm.id;\n      var type = vm.$route.query.type;\n\n      if (type === 'edit' && newId !== oldId) {\n        // 说明是打开另一个单子的编辑页面\n        vm.firstForm.id = newId;\n        vm.initForm();\n        vm.initDataById(newId);\n        vm.active = 1;\n      } else {\n        if (type === 'add' && oldId) {\n          // 说明是打开一个新建页面\n          vm.initForm();\n          vm.active = 1;\n        }\n      }\n    });\n  },\n  methods: {\n    /**\r\n     * 处理项目选择器选择事件\r\n     */\n    handelProjectSelect: function handelProjectSelect(val) {\n      Object.assign(this.firstForm, {\n        orgId: val ? val.orgId : '',\n        companyId: val ? val.companyId : ''\n      });\n      this.getProjectMessage();\n    },\n\n    /**\r\n     * 根据id获取项目信息\r\n     */\n    getProjectMessage: function getProjectMessage() {\n      var _this2 = this;\n\n      if (this.firstForm.projectId === undefined) {\n        this.firstForm.orgName = '';\n        this.firstForm.projectId = '';\n        this.project.orgName = '';\n      } else {\n        var req = {\n          id: this.firstForm.projectId\n        };\n        (0, _project.getProjectById)(req).then(function (_ref) {\n          var data = _ref.data;\n          Object.assign(_this2.firstForm, {\n            contractDuration: data.contractDuration,\n            orgName: data.organization.name\n          });\n        });\n      }\n    },\n\n    /**\r\n     * @description: 清除form数据，清除检验提示\r\n     */\n    initForm: function initForm() {\n      var _this3 = this;\n\n      Object.assign(this.$data.firstForm, this.$options.data().firstForm);\n      this.project = {};\n      this.$nextTick(function () {\n        // 调用表单组件的重置方法\n        _this3.$refs.firstForm.resetFields();\n      });\n    },\n\n    /**\r\n     * @description: 初始化选项框数据\r\n     */\n    initSelect: function initSelect() {\n      var _this4 = this;\n\n      (0, _ProjectStartManage.InitProjectStartManage)().then(function (res) {\n        _this4.filter.startTypeList = res.startTypeList;\n      });\n    },\n\n    /**\r\n     * @description: 根据id获取数据并且初始化选项框数据\r\n     */\n    initDataById: function initDataById(id) {\n      var _this5 = this;\n\n      (0, _ProjectStartManage.GetProjectStartManageById)({\n        id: id\n      }).then(function (res) {\n        var form = _this5.firstForm;\n\n        for (var key in form) {\n          if (Object.hasOwnProperty.call(res.data, key)) {\n            form[key] = res.data[key] || form[key];\n          }\n        }\n\n        form.billFlow = res.billFlowData;\n        form.fileList = res.data.upFile;\n\n        _this5.handelProjectSelect(_this5.firstForm);\n      });\n    },\n    getBillFlow: function getBillFlow() {\n      var _this6 = this;\n\n      // 获取流程数据\n      var _this$firstForm = this.firstForm,\n          state = _this$firstForm.state,\n          billFlow = _this$firstForm.billFlow;\n      var req = (0, _objectSpread2.default)((0, _objectSpread2.default)({}, this.firstForm), {}, {\n        state: state || 0\n      });\n      if (billFlow) req.billFlowId = billFlow.id;\n      delete req.billFlow;\n      delete req.number;\n      (0, _ProjectStartManage.GetBillFlow)(req).then(function (_ref2) {\n        var data = _ref2.data,\n            success = _ref2.success,\n            message = _ref2.message;\n\n        if (success) {\n          _this6.firstForm.billFlow = data.billFlow;\n\n          _this6.setActive(2);\n        } else {\n          _this6.$message.error(message);\n        }\n      });\n    },\n\n    /**\r\n     * 修改填报进度\r\n     */\n    setActive: function setActive(active) {\n      this.active = active;\n    },\n\n    /**\r\n     * 下一步\r\n     */\n    nextStep: function nextStep(formName) {\n      var _this7 = this;\n\n      this.$refs[formName].validate(function () {\n        return _this7.getBillFlow();\n      });\n    },\n    // 作废\n    invalidForm: function invalidForm() {\n      var _this8 = this;\n\n      this.$confirm('作废以后将无法编辑，是否确定作废？', '提示', {\n        type: 'warning'\n      }).then(function () {\n        return (0, _ProjectStartManage.DeleteProjectStartManage)({\n          id: _this8.firstForm.id\n        });\n      }).then(function () {\n        _this8.$message.success('操作成功');\n\n        _this8.back();\n      });\n    },\n\n    /**\r\n     * 提交表单\r\n     * @param {Number} state 提交类型，0：保存；1：提交\r\n     */\n    submitForm: function submitForm(state) {\n      var _this9 = this;\n\n      var req = (0, _objectSpread2.default)((0, _objectSpread2.default)({}, this.firstForm), {}, {\n        state: state\n      });\n      delete req.number;\n\n      if (this.firstForm.billFlow) {\n        // 获取流程组件中的数据\n        var billFlow = this.$refs.flowSelect.getBillFlow();\n\n        if (!billFlow) {\n          return false;\n        }\n\n        req.billFlow = billFlow;\n      } else {\n        this.$message.error('流程数据不能为空');\n        return;\n      }\n\n      if (this.firstForm.progressType === 2 && req.state === 1) {\n        return this.$message.error('进度选项为已上报时，才能提交审批');\n      }\n\n      if (req.id) {\n        (0, _ProjectStartManage.PutProjectStartManage)(req).then(function (res) {\n          _this9.$message.success('保存成功');\n\n          _this9.back();\n        });\n      } else {\n        (0, _ProjectStartManage.AddProjectStartManage)(req).then(function () {\n          _this9.$message.success('提交成功');\n\n          _this9.back();\n        });\n      }\n    },\n\n    /**\r\n     * 返回上一页，并关闭当前页\r\n     */\n    back: function back() {\n      this.utils.closeAndRefresh(this.$route.query.refreshRouterName);\n    }\n  }\n};\nexports.default = _default;",null]}