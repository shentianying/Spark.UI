{"remainingRequest":"D:\\Projects\\spark\\Spark.UI\\node_modules\\babel-loader\\lib\\index.js!D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js??ref--0-0!D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Projects\\spark\\Spark.UI\\src\\views\\cwgl\\zjgl\\Gathering\\edit.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Projects\\spark\\Spark.UI\\src\\views\\cwgl\\zjgl\\Gathering\\edit.vue","mtime":1631087446338},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["\"use strict\";\n\nvar _interopRequireDefault = require(\"D:/Projects/spark/Spark.UI/node_modules/@babel/runtime/helpers/interopRequireDefault\");\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.default = void 0;\n\nvar _objectSpread2 = _interopRequireDefault(require(\"D:/Projects/spark/Spark.UI/node_modules/@babel/runtime/helpers/objectSpread2\"));\n\nrequire(\"core-js/modules/es7.array.includes\");\n\nrequire(\"core-js/modules/web.dom.iterable\");\n\nvar _createForOfIteratorHelper2 = _interopRequireDefault(require(\"D:/Projects/spark/Spark.UI/node_modules/@babel/runtime/helpers/createForOfIteratorHelper\"));\n\nrequire(\"core-js/modules/es6.regexp.replace\");\n\nrequire(\"regenerator-runtime/runtime\");\n\nvar _asyncToGenerator2 = _interopRequireDefault(require(\"D:/Projects/spark/Spark.UI/node_modules/@babel/runtime/helpers/asyncToGenerator\"));\n\nvar _Gathering = require(\"@/api/cwgl/zjgl/Gathering.js\");\n\nvar _pikazExcelJs = require(\"pikaz-excel-js\");\n\nvar _validate = require(\"@/utils/validate\");\n\nvar _index = require(\"@/utils/index\");\n\nvar _OrgSelect = _interopRequireDefault(require(\"@/components/SearchBar/OrgSelect\"));\n\nvar _PersonSelect = _interopRequireDefault(require(\"@/components/SearchBar/PersonSelect2\"));\n\nvar _CapitalSelect = _interopRequireDefault(require(\"@/components/SearchBar/CapitalSelect\"));\n\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\nvar _default = {\n  name: 'ShouKuanEdit',\n  // 局部注册的组件\n  components: {\n    ExcelImport: _pikazExcelJs.ExcelImport,\n    ExcelExport: _pikazExcelJs.ExcelExport,\n    OrgSelect: _OrgSelect.default,\n    PersonSelect: _PersonSelect.default,\n    CapitalSelect: _CapitalSelect.default\n  },\n  // 组件状态值\n  data: function data() {\n    return {\n      size: 'mini',\n      // 整体大小\n      type: '',\n      // edit：编辑 add:新增\n      isCanUpdate: true,\n      // 是否可编辑,备注银行除外\n      skForm: {\n        id: 'add',\n        gatheringDate: '',\n        acceptanceList: [],\n        number: '',\n        // 收款编号\n        orgId: '',\n        // 部门\n        gatheringType: '',\n        // 收款类型\n        capitalType: '',\n        // 资金类型\n        date1: '',\n        // 收款日期\n        personId: '',\n        // 经手人ID\n        personName: '',\n        // 经手人\n        amount: '',\n        // 金额\n        bank: '',\n        // 银行\n        remark: '',\n        // 备注\n        state: -1\n      },\n      defaultParams: {\n        expandTrigger: 'hover',\n        label: 'name',\n        value: 'value',\n        children: 'childs'\n      },\n      sheet: [{\n        // title: '材料计划导入模板',\n        tHeader: ['票号', '开票日期', '到期日期', '金额', '出票人', '付款人', '收款人', '付款行', '备注'],\n        table: [],\n        keys: ['ticketNumber', 'ticketDate', 'expiration', 'amount', 'drawer', 'payer', 'payee', 'bank', 'remark'],\n        sheetName: '材料明细'\n      }],\n      sklxData: [],\n      zjlxData: [],\n      // 验证规则\n      rules: {\n        orgId: [{\n          required: true,\n          message: '请选择部门',\n          trigger: 'change'\n        }],\n        gatheringType: [{\n          required: true,\n          message: '请选择收款类型',\n          trigger: 'change'\n        }],\n        capitalType: [{\n          required: true,\n          message: '请选择资金类型',\n          trigger: 'change'\n        }],\n        gatheringDate: [{\n          required: true,\n          message: '请选择日期',\n          trigger: 'change'\n        }],\n        personId: [{\n          required: true,\n          message: '请选择经手人',\n          trigger: 'change'\n        }],\n        amount: [{\n          required: true,\n          message: '请输入金额',\n          trigger: 'change'\n        }, {\n          validator: _validate.validate.money,\n          message: '金额格式不正确'\n        }, {\n          validator: _validate.validate.max_amount,\n          message: '超过所能存储的最大金额'\n        }]\n      }\n    };\n  },\n  beforeRouteEnter: function beforeRouteEnter(to, from, next) {\n    next(function (vm) {\n      vm.initData();\n    });\n  },\n  // 组件方法\n  methods: {\n    initData: function initData() {\n      var _this$$route$query = this.$route.query,\n          type = _this$$route$query.type,\n          id = _this$$route$query.id;\n\n      if (!type) {\n        return;\n      }\n\n      this.skForm.id = id;\n      this.type = type;\n\n      if (this.type === 'edit') {\n        this.getskForm();\n      } else {\n        this.skForm.state = 0;\n        this.skForm.acceptanceList = [];\n        this.isCanUpdate = true;\n        this.$refs['ruleForm'] && this.$refs['ruleForm'].resetFields();\n        this.getOptions();\n      }\n    },\n    invalidGathering: function () {\n      var _invalidGathering = (0, _asyncToGenerator2.default)( /*#__PURE__*/regeneratorRuntime.mark(function _callee() {\n        var _this = this;\n\n        return regeneratorRuntime.wrap(function _callee$(_context) {\n          while (1) {\n            switch (_context.prev = _context.next) {\n              case 0:\n                // 作废之前弹窗确定一下\n                this.$confirm('作废以后将无法编辑，是否确定作废？', '提示', {\n                  type: 'warning'\n                }).then(function () {\n                  return (0, _Gathering.InvalidGathering)(_this.skForm.id);\n                }).then(function (res) {\n                  _this.$message.success(res.message);\n\n                  _this.utils.closeAndRefresh(_this.$route.query.refreshRouterName);\n                }).catch(function (err) {\n                  console.log(err); // this.$message.error(err.errorMsg || '操作失败')\n                });\n\n              case 1:\n              case \"end\":\n                return _context.stop();\n            }\n          }\n        }, _callee, this);\n      }));\n\n      function invalidGathering() {\n        return _invalidGathering.apply(this, arguments);\n      }\n\n      return invalidGathering;\n    }(),\n    onSuccess: function onSuccess(d, file) {\n      var _this2 = this;\n\n      var data = d[0].data; // const postData = []\n\n      console.log('数据为空的字段data中不会有该字段:', data); // if (data.length) return // 为空返回\n\n      var errorMessage = '';\n      var isEmpyt = data.every(function (e) {\n        // 非空判断\n        if (!e.付款人) {\n          errorMessage += '第' + e.__rowNum__ + '行，付款人不能为空；';\n        }\n\n        if (!e.付款行) {\n          errorMessage += '第' + e.__rowNum__ + '行，付款行不能为空；';\n        }\n\n        if (!e.出票人) {\n          errorMessage += '第' + e.__rowNum__ + '行，出票人不能为空；';\n        }\n\n        if (!e.收款人) {\n          errorMessage += '第' + e.__rowNum__ + '行，收款人不能为空；';\n        }\n\n        if (!e.金额) {\n          errorMessage += '第' + e.__rowNum__ + '行，金额不能为空；';\n        } else if (!_validate.validateData.money(e.金额.trim()).isSuccess) {\n          errorMessage += '第' + e.__rowNum__ + '行，金额格式不正确；';\n        }\n\n        if (!e.开票日期) {\n          errorMessage += '第' + e.__rowNum__ + '行，开票日期不能为空；';\n        } else {\n          /* const convertDate = formatExcelDate(e.开票日期.trim())\r\n          if (!validateData.date(convertDate).isSuccess) {\r\n            errorMessage += '第' + e.__rowNum__ + '行，开票日期格式错误；'\r\n          } */\n        }\n\n        if (!e.到期日期) {\n          errorMessage += '第' + e.__rowNum__ + '行，到期日期不能为空；';\n        } else {\n          /* const convertDate = formatExcelDate(e.到期日期.trim())\r\n          if (!validateData.date(convertDate).isSuccess) {\r\n            errorMessage += '第' + e.__rowNum__ + '行，到期日期格式错误；'\r\n          } */\n        }\n\n        if (e.开票日期 && e.到期日期 && new Date(e.开票日期.trim()) > new Date(e.到期日期.trim())) {\n          errorMessage += '第' + e.__rowNum__ + '行，开票日期不得晚于到期日期；';\n        }\n\n        return errorMessage.length > 0;\n      }); // 表格检验\n\n      this.loading = true;\n\n      if (isEmpyt) {\n        this.$alert(\"\".concat(errorMessage.replace(/；/g, '；<br />')), {\n          dangerouslyUseHTMLString: true\n        });\n        this.loading = false;\n        return;\n      }\n\n      var dateList = ['ticketDate', 'expiration']; // 时间\n\n      var _iterator = (0, _createForOfIteratorHelper2.default)(data),\n          _step;\n\n      try {\n        var _loop = function _loop() {\n          row = _step.value;\n          var sheet = _this2.sheet[0];\n          var tmpRow = {};\n          sheet.keys.forEach(function (key, index) {\n            // 每一行\n            var thName = sheet.tHeader[index]; // 表头名\n\n            tmpRow[key] = row[thName] || (0, _index.cleanText)(index);\n\n            if (dateList.includes(key)) {\n              // 格式化时间\n              console.log(tmpRow[key]);\n              data[key] = (0, _index.formatExcelDate)(tmpRow[key]);\n            }\n          });\n\n          _this2.skForm.acceptanceList.push(tmpRow);\n        };\n\n        for (_iterator.s(); !(_step = _iterator.n()).done;) {\n          var row;\n\n          _loop();\n        }\n      } catch (err) {\n        _iterator.e(err);\n      } finally {\n        _iterator.f();\n      }\n    },\n    // 获取资金类型、收款类型选项\n    getOptions: function () {\n      var _getOptions = (0, _asyncToGenerator2.default)( /*#__PURE__*/regeneratorRuntime.mark(function _callee2() {\n        var _yield$GetGatheringPa, capitalTypeOptions, gatheringTypeOptions;\n\n        return regeneratorRuntime.wrap(function _callee2$(_context2) {\n          while (1) {\n            switch (_context2.prev = _context2.next) {\n              case 0:\n                _context2.next = 2;\n                return (0, _Gathering.GetGatheringPaging)({\n                  currentPage: 1,\n                  pageSize: 1\n                });\n\n              case 2:\n                _yield$GetGatheringPa = _context2.sent;\n                capitalTypeOptions = _yield$GetGatheringPa.capitalTypeOptions;\n                gatheringTypeOptions = _yield$GetGatheringPa.gatheringTypeOptions;\n                this.sklxData = gatheringTypeOptions;\n                this.zjlxData = capitalTypeOptions;\n                console.log(this.zjlxData, 119);\n\n              case 8:\n              case \"end\":\n                return _context2.stop();\n            }\n          }\n        }, _callee2, this);\n      }));\n\n      function getOptions() {\n        return _getOptions.apply(this, arguments);\n      }\n\n      return getOptions;\n    }(),\n    // 获取收款信息数据\n    getskForm: function getskForm() {\n      var _this3 = this;\n\n      (0, _Gathering.GetPaymentById)(this.skForm.id).then(function (res) {\n        var code = res.code,\n            data = res.data,\n            gatheringTypeOptions = res.gatheringTypeOptions,\n            capitalTypeOptions = res.capitalTypeOptions;\n\n        if (code === 200) {\n          _this3.isCanUpdate = data.isCanUpdate;\n\n          for (var key in _this3.skForm) {\n            if (Object.hasOwnProperty.call(_this3.skForm, key)) {\n              _this3.skForm[key] = data[key];\n              /* if (key === 'capitalType') {\r\n                this.skForm[key] = this.findPNode(this.zjlxData, data[key])\r\n              } else {\r\n                this.skForm[key] = data[key]\r\n              } */\n            }\n          }\n\n          if (Array.isArray(_this3.skForm.acceptanceList)) {\n            _this3.skForm.acceptanceList.forEach(function (ele) {\n              _this3.$set(ele, 'isEdit', false);\n\n              _this3.$set(ele, 'backups', JSON.stringify(ele));\n            });\n          }\n\n          _this3.sklxData = gatheringTypeOptions;\n          _this3.zjlxData = capitalTypeOptions; // console.log(this.skForm.capitalType)\n        }\n      }).catch(function (err) {\n        console.log(err); // this.$message.error(err.errorMsg)\n      });\n    },\n    handleEdit: function handleEdit(row) {\n      this.$set(row, 'isEdit', true);\n    },\n    handleSubmitEdit: function handleSubmitEdit(row) {\n      this.$set(row, 'isEdit', false);\n    },\n\n    /**\r\n     * @description: 列表行内编辑取消修改\r\n     * @param {*} row\r\n     * @return {*}\r\n     */\n    handleCancelEdit: function handleCancelEdit(row) {\n      Object.assign(row, JSON.parse(row.backups));\n    },\n    // 提交表单\n    submitForm: function submitForm(formName) {\n      var _this4 = this;\n\n      console.log(111);\n      this.$refs[formName].validate( /*#__PURE__*/function () {\n        var _ref = (0, _asyncToGenerator2.default)( /*#__PURE__*/regeneratorRuntime.mark(function _callee3(valid) {\n          var AcceptanceList, _iterator2, _step2, item, tmp, capitalType, data, res;\n\n          return regeneratorRuntime.wrap(function _callee3$(_context3) {\n            while (1) {\n              switch (_context3.prev = _context3.next) {\n                case 0:\n                  if (!valid) {\n                    _context3.next = 53;\n                    break;\n                  }\n\n                  AcceptanceList = [];\n                  _iterator2 = (0, _createForOfIteratorHelper2.default)(_this4.skForm.acceptanceList);\n                  _context3.prev = 3;\n\n                  _iterator2.s();\n\n                case 5:\n                  if ((_step2 = _iterator2.n()).done) {\n                    _context3.next = 34;\n                    break;\n                  }\n\n                  item = _step2.value;\n\n                  if (item.ticketDate) {\n                    _context3.next = 10;\n                    break;\n                  }\n\n                  _this4.$message.error('请填写开票日期');\n\n                  return _context3.abrupt(\"return\", false);\n\n                case 10:\n                  if (item.expiration) {\n                    _context3.next = 13;\n                    break;\n                  }\n\n                  _this4.$message.error('请填写到期日期');\n\n                  return _context3.abrupt(\"return\", false);\n\n                case 13:\n                  if (!(new Date(item.ticketDate) > new Date(item.expiration))) {\n                    _context3.next = 16;\n                    break;\n                  }\n\n                  _this4.$message.error('开票日期不能晚于到期日期');\n\n                  return _context3.abrupt(\"return\", false);\n\n                case 16:\n                  if (_validate.validateData.money(item.amount).isSuccess) {\n                    _context3.next = 19;\n                    break;\n                  }\n\n                  _this4.$message.error('金额格式不正确');\n\n                  return _context3.abrupt(\"return\", false);\n\n                case 19:\n                  if (item.drawer) {\n                    _context3.next = 22;\n                    break;\n                  }\n\n                  _this4.$message.error('请填写出票人');\n\n                  return _context3.abrupt(\"return\", false);\n\n                case 22:\n                  if (item.payer) {\n                    _context3.next = 25;\n                    break;\n                  }\n\n                  _this4.$message.error('请填写付款人');\n\n                  return _context3.abrupt(\"return\", false);\n\n                case 25:\n                  if (item.payee) {\n                    _context3.next = 28;\n                    break;\n                  }\n\n                  _this4.$message.error('请填写收款人');\n\n                  return _context3.abrupt(\"return\", false);\n\n                case 28:\n                  tmp = (0, _objectSpread2.default)({}, item);\n                  delete tmp.isEdit;\n                  delete tmp.backups;\n                  AcceptanceList.push(tmp);\n\n                case 32:\n                  _context3.next = 5;\n                  break;\n\n                case 34:\n                  _context3.next = 39;\n                  break;\n\n                case 36:\n                  _context3.prev = 36;\n                  _context3.t0 = _context3[\"catch\"](3);\n\n                  _iterator2.e(_context3.t0);\n\n                case 39:\n                  _context3.prev = 39;\n\n                  _iterator2.f();\n\n                  return _context3.finish(39);\n\n                case 42:\n                  console.info(AcceptanceList, 777);\n                  capitalType = String(_this4.skForm.capitalType);\n                  data = (0, _objectSpread2.default)((0, _objectSpread2.default)({}, _this4.skForm), {}, {\n                    AcceptanceList: []\n                  });\n\n                  if (capitalType === '2' || capitalType === '3') {\n                    data.AcceptanceList = AcceptanceList;\n                  }\n\n                  if (data.acceptanceList) {\n                    delete data.acceptanceList;\n                  }\n\n                  if (!data.id) {\n                    delete data.id;\n                  }\n\n                  _context3.next = 50;\n                  return (0, _Gathering.SaveGathering)(data);\n\n                case 50:\n                  res = _context3.sent;\n\n                  _this4.utils.closeAndRefresh(_this4.$route.query.refreshRouterName);\n\n                  _this4.$message.success(res.message);\n\n                case 53:\n                case \"end\":\n                  return _context3.stop();\n              }\n            }\n          }, _callee3, null, [[3, 36, 39, 42]]);\n        }));\n\n        return function (_x) {\n          return _ref.apply(this, arguments);\n        };\n      }());\n    },\n    addRow: function addRow() {\n      var row = {\n        isEdit: false,\n        isAdd: true\n      };\n      this.$set(row, 'backups', JSON.stringify(row));\n      row.isEdit = true;\n      this.skForm.acceptanceList.push(row);\n    },\n    deleteRow: function deleteRow(index, rows) {\n      rows.splice(index, 1);\n    },\n\n    /**\r\n     * 取消并返回上一页\r\n     */\n    goBack: function goBack() {\n      this.utils.closeAndRefresh(this.$route.query.refreshRouterName);\n    }\n  }\n};\nexports.default = _default;",null]}