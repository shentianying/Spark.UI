{"remainingRequest":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Projects\\spark\\Spark.UI\\src\\views\\fbgl\\fbdwgl\\Subcontractor\\edit.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Projects\\spark\\Spark.UI\\src\\views\\fbgl\\fbdwgl\\Subcontractor\\edit.vue","mtime":1635844823962},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\nimport MyForm from '@/components/MyForm'\r\n// import UpFile from '@/components/UpLoad/UpFile'\r\nimport { validate } from '@/utils/validate'\r\nimport { InitSubcontractor, AddSubcontractor, GetSubcontractorById, PutSubcontractor } from '@/api/fbgl/subcontractor'\r\nexport default {\r\n  name: 'SubcontractorEdit',\r\n  components: {\r\n    MyForm\r\n  },\r\n  data() {\r\n    return {\r\n      subcontractorAssesmentId: '', // 分包星级评审id\r\n      state: 0,\r\n      labelWidth: '160px',\r\n      size: 'mini',\r\n      selectPlaceholder: '输入选择',\r\n      inputPlaceholder: '请输入',\r\n      firstForm: {\r\n        id: 0, // 新增为0\r\n        companyId: '', // 公司id\r\n        number: '', // 新增时,编号后端生成\r\n        orgId: '', // 部门id\r\n        name: '', // 分包单位,\r\n        subContractorType: '', // 分包类型\r\n        address: '', // 注册地址\r\n        postAddress: '', // 邮寄地址\r\n        capital: '', // 注册资本\r\n        mainBusiness: '', // 经营范围\r\n        corporation: '', // 法定代表人\r\n        entrustedAgent: '', // 委托代理人\r\n        phone: '', // 手机\r\n        tel: '', // 固话\r\n        fax: '', // 传真\r\n        email: '', // 邮箱\r\n        regDate: '', // 成立日期\r\n        taxpayerType: '', // 纳税人性质\r\n        workerNum: '', // 工人数量\r\n        isForbidden: 0, // 是否禁用\r\n        bussinessType: [], // 可承接业务类型\r\n        projectType: [], // 可承接工程类型\r\n        businessCity: [], // 可施工区域\r\n        postCertificate: '', // 上岗证书\r\n        remark: '', // 备注\r\n        licenseFileList: [], // 营业执照\r\n        license: [],\r\n        licenseStart: '', // 营业期限\r\n        licenseEnd: '', // 营业期限\r\n        accountFileList: [], // 开户许可证\r\n        corporationFileList: [], // 法定代表人身份证明\r\n        infoFileList: [], // 分包考察资料\r\n        deliveryStatementFileList: [], // 送达声明\r\n        taxpayerCerFileList: [], // 纳税人信息证明\r\n        qualificationFileList: [], // 施工资质证书\r\n        qualificationNum: '', // 编号\r\n        regScopeStart: '', // 登记范围\r\n        regScopeEnd: '', // 登记范围\r\n        safetyFileList: [], // 安全生产许可证\r\n        safetyCerNum: '', // 编号\r\n        safetyPeriod: [],\r\n        safetyPeriodStart: '', // 有效期\r\n        safetyPeriodEnd: '', // 有效期\r\n        financeReportFileList: [], // 财务审计报告\r\n        fileList: [], // 其他附件\r\n        rate: -1 // 星级默认不合格\r\n      },\r\n      firstRules: {\r\n        orgId: [\r\n          { required: true, message: '请选择部门', trigger: 'change' }\r\n        ],\r\n        name: [\r\n          { required: true, message: '请输入单位名称', trigger: 'change' }\r\n        ],\r\n        subContractorType: [\r\n          { required: true, message: '请选择分包类型', trigger: 'change' }\r\n        ],\r\n        address: [\r\n          { required: true, message: '请输入注册地址', trigger: 'change' }\r\n        ],\r\n        postAddress: [\r\n          { required: true, message: '请输入邮寄地址', trigger: 'change' }\r\n        ],\r\n        capital: [\r\n          { required: true, message: '请输入注册资本', trigger: 'change' },\r\n          { validator: validate.money, message: '金额格式不正确', trigger: 'change' },\r\n          { validator: validate.max_amount, message: '超过所能存储的最大金额', trigger: 'change' }\r\n        ],\r\n        mainBusiness: [\r\n          { required: true, message: '请输入经营范围', trigger: 'change' }\r\n        ],\r\n        corporation: [\r\n          { required: true, message: '请输入法定代表人', trigger: 'change' }\r\n        ],\r\n        entrustedAgent: [\r\n          { required: true, message: '请输入委托代理人', trigger: 'change' }\r\n        ],\r\n        phone: [\r\n          { required: true, message: '请输入手机号', trigger: 'change' },\r\n          { validator: validate.mobile, message: '手机号格式不正确', trigger: 'change' }\r\n        ],\r\n        // tel: [\r\n        //   { validator: validate.phone, message: '固话格式不正确', trigger: 'change' }\r\n        // ],\r\n        // email: [\r\n        //   { validator: validate.email, message: 'Email格式不正确', trigger: 'change' }\r\n        // ],\r\n        regDate: [\r\n          { required: true, message: '请选择成立日期', trigger: 'change' }\r\n        ],\r\n        taxpayerType: [\r\n          { required: true, message: '选择纳税人性质', trigger: 'change' }\r\n        ],\r\n        workerNum: [\r\n          { required: true, message: '请输入工人数量', trigger: 'change' },\r\n          { validator: validate.int, message: '必须为整数', trigger: 'change' }\r\n        ],\r\n        isForbidden: [\r\n          { required: true, message: '请选择是否禁用', trigger: 'change' }\r\n        ],\r\n        bussinessType: [\r\n          { required: true, message: '请选择业务类型', trigger: 'change' }\r\n        ],\r\n        projectType: [\r\n          { required: true, message: '请选择工程类型', trigger: 'change' }\r\n        ],\r\n        businessCity: [\r\n          { required: true, message: '请选择可施工区域', trigger: 'change' }\r\n        ],\r\n        licenseFileList: [\r\n          { required: true, message: '请上传营业执照', trigger: 'change' }\r\n        ],\r\n        license: [\r\n          { required: true, message: '请上选择营业期限', trigger: 'change' }\r\n        ],\r\n        accountFileList: [\r\n          { required: true, message: '请上传开户许可证', trigger: 'change' }\r\n        ],\r\n        corporationFileList: [\r\n          { required: true, message: '请上传法定代表人身份证明', trigger: 'change' }\r\n        ],\r\n        infoFileList: [\r\n          { required: true, message: '请上传分包考察资料', trigger: 'change' }\r\n        ],\r\n        deliveryStatementFileList: [\r\n          { required: true, message: '请上传送达声明', trigger: 'change' }\r\n        ]\r\n      },\r\n      filter: {\r\n        isForbiddenalist: [\r\n          { label: '是', value: 1 },\r\n          { label: '否', value: 0 }\r\n        ],\r\n        subcontractorTypeList: [], // 分包类型列表\r\n        taxpayerTypeList: [], // 纳税人性质列表\r\n        bussinessTypeList: [], // 可承接业务类型\r\n        projectTypeList: [], // 可承接工程类型\r\n        bussinessCityList: [], // 可施工区域\r\n        rateList: '' // 星级列表数据\r\n      }\r\n    }\r\n  },\r\n  computed: {\r\n    formNodeData() {\r\n      const {\r\n        size,\r\n        selectPlaceholder,\r\n        inputPlaceholder,\r\n        firstForm,\r\n        filter: {\r\n          subcontractorTypeList,\r\n          taxpayerTypeList,\r\n          bussinessTypeList,\r\n          projectTypeList,\r\n          bussinessCityList,\r\n          isForbiddenalist\r\n        }\r\n      } = this\r\n      return [\r\n        { label: '编号:', keyword: 'number', props: { disabled: true, placeholder: '系统自动生成' }},\r\n        { label: '部门:', keyword: 'orgId', component: 'OrgSelect', props: { placeholder: selectPlaceholder }},\r\n        { label: '单位名称:', keyword: 'name', props: { placeholder: inputPlaceholder }},\r\n        { label: '分包类型:', keyword: 'subContractorType', component: 'Select', props: { propsLabel: 'name', placeholder: selectPlaceholder, options: subcontractorTypeList }},\r\n        { label: '注册地址:', keyword: 'address', props: { placeholder: inputPlaceholder }},\r\n        { label: '邮寄地址:', keyword: 'postAddress', props: { placeholder: inputPlaceholder }},\r\n        { label: '注册资本:', keyword: 'capital', component: 'Input', props: { placeholder: inputPlaceholder, unit: '万元' }},\r\n        { label: '经营范围:', keyword: 'mainBusiness', props: { placeholder: inputPlaceholder }},\r\n        { label: '法定代表人:', keyword: 'corporation', props: { placeholder: inputPlaceholder }},\r\n        { label: '委托代理人:', keyword: 'entrustedAgent', props: { placeholder: inputPlaceholder }},\r\n        { label: '手机:', keyword: 'phone', props: { placeholder: inputPlaceholder }},\r\n        { label: '固话:', keyword: 'tel', props: { placeholder: inputPlaceholder }},\r\n        { label: '传真:', keyword: 'fax', props: { placeholder: inputPlaceholder }},\r\n        { label: '邮箱:', keyword: 'email', props: { placeholder: inputPlaceholder }},\r\n        { label: '成立日期:', keyword: 'regDate', component: 'el-date-picker', props: { type: 'date', placeholder: selectPlaceholder, valueFormat: 'yyyy-MM-dd' }},\r\n        { label: '纳税人性质:', keyword: 'taxpayerType', component: 'Select', props: { propsLabel: 'name', placeholder: selectPlaceholder, options: taxpayerTypeList }},\r\n        { label: '工人数量:', keyword: 'workerNum', props: { placeholder: inputPlaceholder }},\r\n        { label: '是否禁用:', keyword: 'isForbidden', component: 'Select', props: { placeholder: selectPlaceholder, options: isForbiddenalist }},\r\n        { label: '可承接业务类型:', keyword: 'bussinessType', component: 'Select', props: { propsLabel: 'name', multiple: true, placeholder: selectPlaceholder, options: bussinessTypeList }},\r\n        { label: '可承接工程类型:', keyword: 'projectType', component: 'Select', props: { propsLabel: 'name', multiple: true, placeholder: selectPlaceholder, options: projectTypeList }},\r\n        { label: '可施工区域:', monopolize: true, keyword: 'businessCity', component: 'TreeSelect', props: { propsValue: 'id', propsLabel: 'name', multiple: true, placeholder: selectPlaceholder, options: bussinessCityList }},\r\n        { label: '上岗证书:', keyword: 'postCertificate', props: { placeholder: inputPlaceholder, type: 'textarea' }},\r\n        { label: '备注:', keyword: 'remark', props: { placeholder: inputPlaceholder, type: 'textarea' }},\r\n        /* component: 'UpFile', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true } */\r\n        /* render: h => (\r\n          <UpFile\r\n            isUpfile={true}\r\n            isDelete={true}\r\n            fileSize={100}\r\n            isPreview={true}\r\n            fileList={firstForm.licenseFileList}\r\n          ></UpFile>\r\n        )  */\r\n        { label: '营业执照:', monopolize: true, keyword: 'licenseFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '营业期限:', monopolize: true, keyword: 'license', component: 'DateRange', width: '100%', props: { type: 'monthrange', placeholder: selectPlaceholder, valueFormat: 'yyyy-MM' }},\r\n        { label: '开户许可证:', monopolize: true, keyword: 'accountFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '法定代表人身份证明:', monopolize: true, keyword: 'corporationFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '分包考察资料:', monopolize: true, keyword: 'infoFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '送达声明:', monopolize: true, keyword: 'deliveryStatementFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '纳税人证明信息:', monopolize: true, keyword: 'taxpayerCerFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '施工资质证书:', monopolize: true, keyword: 'qualificationFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '编号:', keyword: 'qualificationNum', props: { placeholder: inputPlaceholder }},\r\n        { label: '登记范围:', props: { placeholder: inputPlaceholder }, width: '100%', render: h => (<div class='input-range'>\r\n          <el-input v-model={firstForm.regScopeStart} clearable class='input' size={size} placeholder={inputPlaceholder} />\r\n          <i class='el-icon-right' />\r\n          <el-input v-model={firstForm.regScopeEnd} clearable class='input' size={size} placeholder={inputPlaceholder} /></div>) },\r\n        { label: '安全生产许可证:', monopolize: true, keyword: 'safetyFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '编号:', keyword: 'safetyCerNum', props: { placeholder: inputPlaceholder }},\r\n        { label: '有效期:', keyword: 'safetyPeriod', component: 'DateRange', width: '100%', props: { placeholder: selectPlaceholder, transformType: 'property-serial' }},\r\n        { label: '财务审计报告:', monopolize: true, keyword: 'financeReportFileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }},\r\n        { label: '其他:', monopolize: true, keyword: 'fileList', component: 'UpFile', width: '100%', props: { isUpfile: true, isDelete: true, fileSize: 100, isPreview: true }}\r\n      ]\r\n    }\r\n  },\r\n  beforeRouteEnter(to, from, next) {\r\n    next(vm => {\r\n      vm.initSelect()\r\n      const newId = vm.$route.query.id\r\n      const oldId = vm.firstForm.id\r\n      const type = vm.$route.query.type\r\n      vm.subcontractorAssesmentId = vm.$route.query.subcontractorAssesmentId || ''\r\n      // vm.filter.rateList = JSON.parse(vm.$route.query.rateList)\r\n      vm.filter.rateList = vm.$route.query.rateList\r\n      if (type === 'edit' && newId !== oldId) {\r\n      // 说明是打开另一个单子的编辑页面\r\n        vm.firstForm.id = newId\r\n        vm.initForm()\r\n        vm.initDataById(newId)\r\n      } else {\r\n        const form = vm.firstForm\r\n        form.companyId = vm.$store.state.user.selectOrgId\r\n        // 由于缓存的原因，防止上一次是编辑留下的数据，所以需要判断一下oldId\r\n        if (type === 'add' && oldId) {\r\n          vm.initForm()\r\n        }\r\n      }\r\n    })\r\n  },\r\n  methods: {\r\n    // 设置营业期限\r\n    setLicense(val) {\r\n      this.firstForm.licenseStart = val[0]\r\n      this.firstForm.licenseEnd = val[1]\r\n    },\r\n    // 上传文件之后清空校验信息\r\n    fileListRest(type) {\r\n      this.$refs.firstForm.clearValidate(type)\r\n    },\r\n    // 设置有效期\r\n    setSafetyPeriod(val) {\r\n      this.firstForm.safetyPeriodStart = val[0]\r\n      this.firstForm.safetyPeriodEnd = val[1]\r\n    },\r\n    initSelect() {\r\n      InitSubcontractor().then(res => {\r\n        const { subcontractorTypeList, taxpayerTypeList, bussinessTypeList, projectTypeList, bussinessCityList } = res\r\n        this.filter.subcontractorTypeList = subcontractorTypeList\r\n        this.filter.taxpayerTypeList = taxpayerTypeList\r\n        this.filter.bussinessTypeList = bussinessTypeList\r\n        this.filter.projectTypeList = projectTypeList\r\n        this.filter.bussinessCityList = bussinessCityList\r\n      })\r\n    },\r\n    initForm() {\r\n      Object.assign(this.$data.firstForm, this.$options.data().firstForm)\r\n      this.$nextTick(() => {\r\n        this.$refs.firstForm.clearValidate()\r\n      })\r\n    },\r\n    /**\r\n     * 提交表单\r\n     * @param {Number} state 提交类型，0：保存；1：提交; 10000: 修改\r\n     */\r\n    submitForm(formName) {\r\n      this.$refs[formName].validate(valid => {\r\n        if (valid) {\r\n          const { bussinessType, businessCity, projectType } = this.firstForm\r\n          const form = {\r\n            bussinessType, businessCity, projectType\r\n          }\r\n          if (!this.firstForm.licenseStart || !this.firstForm.licenseEnd) {\r\n            this.$message.error('请选择营业期限')\r\n            return\r\n          }\r\n          form.bussinessType = form.bussinessType.join(',')\r\n          form.businessCity = Array.isArray(form.businessCity) ? form.businessCity.join(',') : form.businessCity\r\n          form.projectType = form.projectType.join(',')\r\n          const req = {\r\n            ...this.firstForm,\r\n            ...form\r\n          }\r\n          delete req.number\r\n          delete req.license\r\n          delete req.safetyPeriod\r\n          if (req.id) {\r\n            PutSubcontractor(req).then(res => {\r\n              // 更新\r\n              this.$message.success('保存成功')\r\n              this.back()\r\n            })\r\n          } else {\r\n            AddSubcontractor(req).then(() => {\r\n              // 添加\r\n              this.$message.success('提交成功')\r\n              this.back()\r\n            })\r\n          }\r\n        }\r\n      })\r\n    },\r\n    /**\r\n     * @description: 根据id获取数据并且初始化选项框数据\r\n     */\r\n    initDataById(id) {\r\n      GetSubcontractorById({ id }).then(res => {\r\n        const form = this.firstForm\r\n        for (const key in form) {\r\n          if (Object.hasOwnProperty.call(form, key)) {\r\n            form[key] = res.data[key] || form[key]\r\n          }\r\n        }\r\n        form.isForbidden = Number(form.isForbidden)\r\n        this.parseServeDate(form, res.data)\r\n      })\r\n    },\r\n    /* 处理多选数据 和 文件列表数据 */\r\n    parseServeDate(form, data) {\r\n      form.projectType = form.projectType.split(',')\r\n      form.bussinessType = form.bussinessType.split(',')\r\n      form.businessCity = form.businessCity.split(',')\r\n      form.bussinessType = form.bussinessType.map(Number)\r\n      form.projectType = form.projectType.map(Number)\r\n      form.businessCity = form.businessCity.map(Number)\r\n      form.fileList = data.upFile\r\n      form.licenseFileList = data.licenseUpFile\r\n      // 营业期限\r\n      form.license = [form.licenseStart, form.licenseEnd]\r\n      // 安全有效期\r\n      form.safetyPeriod = [form.safetyPeriodStart, form.safetyPeriodEnd]\r\n      form.accountFileList = data.accountUpFile\r\n      form.corporationFileList = data.corporationUpFile\r\n      form.infoFileList = data.infoUpFile\r\n      form.deliveryStatementFileList = data.deliveryStatementUpFile\r\n      form.taxpayerCerFileList = data.taxpayerCerUpFile\r\n      form.qualificationFileList = data.qualificationUpFile\r\n      form.safetyFileList = data.safetyUpFile\r\n      form.financeReportFileList = data.financeReportUpFile\r\n    },\r\n    /* 提交评审 */\r\n    submitRate(type, id) {\r\n      if (this.firstForm.id) {\r\n        this.$router.push({ name: 'SubcontractorDetails', query: { type, id, subcontractorAssesmentId: this.subcontractorAssesmentId, rateList: this.filter.rateList, refreshRouterName: this.$route.name }})\r\n      } else {\r\n        this.$message.error('请先保存数据!')\r\n      }\r\n    },\r\n    /**\r\n     * 返回上一页，并关闭当前页\r\n     */\r\n    back() {\r\n      this.utils.closeAndRefresh(this.$route.query.refreshRouterName)\r\n    }\r\n  }\r\n}\r\n",null]}