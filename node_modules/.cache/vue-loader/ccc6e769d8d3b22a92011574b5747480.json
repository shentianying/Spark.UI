{"remainingRequest":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Projects\\spark\\Spark.UI\\src\\views\\cggl\\fapiao\\faPiaoEdit.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Projects\\spark\\Spark.UI\\src\\views\\cggl\\fapiao\\faPiaoEdit.vue","mtime":1627284170941},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\n// import { getPlanBillAttitudeById } from '@/api/cggl/plan'\r\nimport { getBillFlow, deleteDesignOrder, addPlanDesignOrder, getPlanDesignOrderById, putPlanDesignOrder, checkImportExcel, checkPlanDesignOrderDetail } from '@/api/cggl/designOrder'\r\n\r\nimport OrgSelect2 from '@/components/OrgSelect/index2'\r\nimport FlowSelect from '@/components/Flow/flowSelect'\r\n// import FlowDisplay from '@/components/Flow/flowDisplay'\r\n// import FlowAttitude from '@/components/Flow/flowAttitude'\r\n// import UpFile from '@/components/UpLoad/UpFile'\r\nimport { ExcelExport, ExcelImport } from 'pikaz-excel-js'\r\nimport { cleanText } from '@/utils/index'\r\nexport default {\r\n  name: 'CGFaPiaoEdit',\r\n  components: {\r\n    OrgSelect2,\r\n    FlowSelect,\r\n    // UpFile,\r\n    ExcelExport,\r\n    ExcelImport\r\n  },\r\n  data() {\r\n    return {\r\n      ruleForm: {\r\n        id: 0,\r\n        number: '',\r\n        orgId: 0,\r\n        state: 0,\r\n        billFlowId: 0,\r\n        planDesignOrderDetail: []\r\n      },\r\n      loading: false,\r\n      isLoad: true,\r\n      activate: false,\r\n      active: 0,\r\n\r\n      list: [],\r\n      orgStr: '',\r\n      billFlow: null,\r\n\r\n      columnShow: { unit2: true,\r\n        brand: true,\r\n        model: true,\r\n        spec: true,\r\n        thickness: true,\r\n        texture: true,\r\n        surfaceTreatment: true,\r\n        designNumber: true },\r\n      sheet: [{\r\n        // title: '材料计划导入模板',\r\n        tHeader: ['计划材料明细编号', '材料名称', '品牌/产地', '型号', '规格/尺寸', '厚度', '材质', '表面处理/工艺、色号', '设计编号', '主数量', '辅数量', '备注'],\r\n        keys: ['planDetailId', 'categoryName', 'brand', 'model', 'spec', 'thickness', 'texture', 'surfaceTreatment', 'designNumber', 'quantity', 'quantity2', 'remark'],\r\n        table: [], // 默认数据\r\n        // colWidth: ['10', '15', '15', '10', '30'],\r\n        // cellStyle: ['string', 'string', 'string', 'string', 'string'], // 单元格样式\r\n        sheetName: '设计下单'\r\n      }],\r\n      rules: {\r\n        orgId: [{ required: true, message: '请输入', trigger: 'change' }]\r\n        // planType: [{ required: true, message: '请输入', trigger: 'blur' }]\r\n      }\r\n    }\r\n  },\r\n  watch: {\r\n    'ruleForm.orgId': {\r\n      handler: function(value, oldvalue) {\r\n        if (!oldvalue) {\r\n          this.$refs['ruleForm'].validateField('orgId', (valid) => {})\r\n        }\r\n      }, deep: true\r\n    }\r\n  },\r\n  activated() {\r\n    if (this.$route.params.id) {\r\n      // this.ruleForm.orgId = null // 刷新 org 列表\r\n      this.initData()\r\n      this.refreshRouterName = this.$route.params.refreshRouterName\r\n    }\r\n  },\r\n  mounted() {\r\n    if (!this.$route.params.id) {\r\n      this.active = 0\r\n      this.activate = true\r\n    }\r\n  },\r\n  methods: {\r\n    initData() {\r\n      // 有参数id 就是编辑\r\n      if (this.$route.query.id) {\r\n        this.ruleForm.id = this.$route.query.id\r\n        this.loading = true\r\n        this.activate = false\r\n        getPlanDesignOrderById({ id: this.ruleForm.id }).then(response => this.setData(response))\r\n      }\r\n    },\r\n    setData(response) {\r\n      const { data } = response\r\n      // data == null ,新增。 data != null && state =0 ,就是编辑 else 就是流程审核\r\n      // 如果设计下单存在 并且 状态是审批状态的话，就关闭页面，阻止编辑\r\n      if (data) {\r\n        if (data.state > 0) {\r\n          this.$message.info('单据已在审批阶段，无法制单')\r\n          this.closeThePage()\r\n          return\r\n        }\r\n      }\r\n      var pom = []\r\n      data.planDesignOrderDetail.forEach(e => {\r\n        const { material } = e\r\n        const { materialCategory } = material\r\n\r\n        pom.push({\r\n          id: e.id,\r\n          planDetailId: e.planDetailId,\r\n          planDesignOrderId: e.planDesignOrderId,\r\n          materialId: e.materialId,\r\n          categoryId: material.categoryId,\r\n          categoryName: materialCategory.name,\r\n          categoryUnit: materialCategory.unit, // 主单位\r\n          unit2: material.unit2,\r\n          brand: material.brand,\r\n          model: material.model,\r\n          spec: material.spec,\r\n          thickness: material.thickness,\r\n          texture: material.texture,\r\n          surfaceTreatment: material.surfaceTreatment,\r\n          designNumber: material.designNumber,\r\n          // applicationQuantity: e.applicationQuantity,\r\n          // applicationQuantity2: e.applicationQuantity2,\r\n          quantity: e.quantity,\r\n          quantity2: e.quantity2,\r\n          entryDate: e.entryDate,\r\n          remark: e.remark\r\n        })\r\n      })\r\n      // 填充 明细列表\r\n      this.list = pom\r\n\r\n      this.setColumnShow()\r\n\r\n      // 获取 设计下单 数据\r\n      if (data) {\r\n        // 设计下单制单 保存 状态\r\n        if (data.state === 0) {\r\n          // this.ruleForm.id = data.id\r\n          this.ruleForm.billFlowId = data.billFlowId\r\n          this.ruleForm.number = data.number\r\n          this.ruleForm.orgId = data.orgId\r\n        } else {\r\n          // state > 0 设计下单 审核流程 状态，跳转到 审核页面\r\n          this.loading = false\r\n          this.$router.replace(\r\n            { name: 'DesignOrderAttitude',\r\n              query: { id: this.ruleForm.planId, refreshRouterName: this.refreshRouterName },\r\n              params: { id: this.ruleForm.planId }\r\n            })\r\n        }\r\n      }\r\n      this.loading = false // loading 状态关闭\r\n      this.activate = true // 加载部门组件\r\n    },\r\n    closeThePage() {\r\n      this.utils.closeAndRefresh(this.$route.query.refreshRouterName)\r\n    },\r\n    setColumnShow() { // 设置列的显示。列中，都没有值，就隐藏\r\n      var modelunit2 = false\r\n      var modelbrand = false\r\n      var modelmodel = false\r\n      var modelspec = false\r\n      var modelthickness = false\r\n      var modeltexture = false\r\n      var modelsurfaceTreatment = false\r\n      var modeldesignNumber = false\r\n      for (var row of this.list) {\r\n        if (row.unit2) { modelunit2 = true }\r\n        if (row.brand) { modelbrand = true }\r\n        if (row.model) { modelmodel = true }\r\n        if (row.spec) { modelspec = true }\r\n        if (row.thickness) { modelthickness = true }\r\n        if (row.texture) { modeltexture = true }\r\n        if (row.surfaceTreatment) { modelsurfaceTreatment = true }\r\n        if (row.designNumber) { modeldesignNumber = true }\r\n      }\r\n      this.columnShow['unit2'] = modelunit2\r\n      this.columnShow['brand'] = modelbrand\r\n      this.columnShow['model'] = modelmodel\r\n      this.columnShow['spec'] = modelspec\r\n      this.columnShow['thickness'] = modelthickness\r\n      this.columnShow['texture'] = modeltexture\r\n      this.columnShow['surfaceTreatment'] = modelsurfaceTreatment\r\n      this.columnShow['designNumber'] = modeldesignNumber\r\n    },\r\n    onError(err) {\r\n      this.$message.info('导出失败：' + err)\r\n    },\r\n    // 导入\r\n    onSuccess(d, file) {\r\n      if (!this.ruleForm.orgId) {\r\n        this.$message('请选择项目')\r\n        return\r\n      }\r\n\r\n      var data = d[0].data\r\n      if (data.length) {\r\n        var errorMessage = ''\r\n        var arr1 = []\r\n        for (var e of data) {\r\n          if (errorMessage.length > 0) {\r\n            this.$alert(`${errorMessage.replace(/；/g, '；<br />')}`,\r\n              { dangerouslyUseHTMLString: true })\r\n            return\r\n          }\r\n\r\n          var obj1 = {}\r\n          this.sheet[0].keys.forEach((v, i) => {\r\n            var value = e[this.sheet[0].tHeader[i]]\r\n            value = cleanText(value)\r\n            // console.log('v:', v, '- value:', value)\r\n            if (v === 'applicationQuantity') { v = 'quantity' }\r\n            if (v === 'applicationQuantity2') { v = 'quantity2' }\r\n            obj1[v] = value\r\n          })\r\n\r\n          obj1['id'] = 0\r\n          obj1['planDesignOrderId'] = 0\r\n          arr1.push(obj1)\r\n        }\r\n        // console.log('取得导入数据：', arr1)\r\n        this.list = arr1\r\n        var newObj = JSON.parse(JSON.stringify(this.ruleForm))\r\n        newObj.planDesignOrderDetail = this.getPlanDesignOrderDetail()\r\n        // 判断导入的数据是否合法\r\n        checkImportExcel(newObj).then(res => {\r\n          if (res.result === 400) {\r\n            this.list = []\r\n            this.$alert(`${res.msg.replace(/；/g, '；<br />')}`, { dangerouslyUseHTMLString: true })\r\n            return false\r\n          } else {\r\n            this.list = arr1\r\n            this.ruleForm.planDesignOrderDetail = this.getPlanDesignOrderDetail()\r\n            this.setColumnShow()\r\n          }\r\n        })\r\n      } else {\r\n        this.$message.info('模板中数据不能为空')\r\n      }\r\n    },\r\n    submitForm(state) {\r\n      var newObj = JSON.parse(JSON.stringify(this.ruleForm))\r\n      // 设计下单状态\r\n      newObj.state = state\r\n      // console.log('提交前：this.list:', this.list)\r\n      newObj.planDesignOrderDetail = this.getPlanDesignOrderDetail()\r\n\r\n      // 获取流程组件中的数据\r\n      if (state === 1) {\r\n        // 如果是提交，验证流程人员的完整信息\r\n        const checkBillFlow = this.$refs.flowSelect.checkBillFlow()\r\n        if (!checkBillFlow) {\r\n          this.$message('流程错误，流程中审批人员不能为空')\r\n          return false\r\n        }\r\n      }\r\n      const billFlow = this.$refs.flowSelect.getBillFlow()\r\n      newObj.billFlow = billFlow\r\n\r\n      // console.log('设计下单提交的数据：', newObj)\r\n      // 保存单据\r\n      // this.loading = true\r\n      if (this.ruleForm.id) {\r\n        putPlanDesignOrder(newObj).then(response => {\r\n          if (response.errorMsg) {\r\n          // 验证错误\r\n            this.$alert(`${response.errorMsg.replace(/；/g, '；<br />')}`,\r\n              { dangerouslyUseHTMLString: true })\r\n            return\r\n          }\r\n          this.$message(response.message)\r\n          this.loading = false\r\n          this.closeThePage()\r\n        }).catch(() => { this.loading = false })\r\n      } else {\r\n        addPlanDesignOrder(newObj).then(response => {\r\n          if (response.errorMsg) {\r\n            // 验证错误\r\n            this.$alert(`${response.errorMsg.replace(/；/g, '；<br />')}`,\r\n              { dangerouslyUseHTMLString: true })\r\n          } else {\r\n            this.$message(response.message)\r\n            this.loading = false\r\n            this.closeThePage()\r\n          }\r\n        }).catch(() => { this.loading = false })\r\n      }\r\n    },\r\n    previous() {\r\n      // 上一步\r\n      this.active = 0\r\n      this.billFlow = null\r\n    },\r\n    cancel() { // 作废\r\n      this.$confirm('作废以后将无法编辑，是否确定作废？', '提示', {\r\n        type: 'warning'\r\n      }).then(() => {\r\n        this.loading = true\r\n        deleteDesignOrder({ id: this.ruleForm.id }).then(response => {\r\n          this.$message(response.message)\r\n          this.loading = false\r\n          this.closeThePage()\r\n        })\r\n      }).catch(() => {})\r\n    },\r\n    getDynamicFlow() {\r\n      this.$refs['ruleForm'].validate(valid => {\r\n        if (valid) {\r\n          if ((this.list || []).length === 0) {\r\n            this.$alert('请导入设计下单明细')\r\n            return\r\n          }\r\n          var newObj = JSON.parse(JSON.stringify(this.ruleForm))\r\n          // delete newObj.planDesignOrderDetail\r\n          // newObj.planDesignOrderDetail = this.getPlanDesignOrderDetail()\r\n          // 拼接材料明细参数\r\n          this.loading = true\r\n          // 验证信息\r\n          checkPlanDesignOrderDetail(this.getPlanDesignOrderDetail()).then(response => {\r\n            if (response.result === 400) {\r\n              this.$alert(`${response.msg.replace(/；/g, '；<br />')}`,\r\n                { dangerouslyUseHTMLString: true })\r\n            } else {\r\n              // console.log('getBillFlow11:', newObj)\r\n              getBillFlow(newObj).then(response => {\r\n                this.loading = false\r\n                if (response.success) {\r\n                  this.billFlow = response.data.billFlow\r\n                  this.active = 1\r\n                } else {\r\n                  this.$message(response.message)\r\n                }\r\n              }).catch(() => { this.loading = false })\r\n            }\r\n            this.loading = false\r\n          }).catch(() => { this.loading = false })\r\n        }\r\n      })\r\n    },\r\n    getPlanDesignOrderDetail() {\r\n      return this.list.map(m => {\r\n        return {\r\n          id: m.id,\r\n          planDetailId: m.planDetailId,\r\n          planDesignOrderId: m.planDesignOrderId,\r\n          quantity: m.quantity,\r\n          quantity2: m.quantity2,\r\n          materialId: m.materialId,\r\n          remark: m.remark,\r\n          material: {\r\n            categoryId: m.categoryId,\r\n            categoryName: m.categoryName,\r\n            unit2: '块',\r\n            brand: m.brand,\r\n            model: m.model,\r\n            spec: m.spec,\r\n            thickness: m.thickness,\r\n            texture: m.texture,\r\n            surfaceTreatment: m.surfaceTreatment,\r\n            designNumber: m.designNumber\r\n          }\r\n        }\r\n      })\r\n    }\r\n  }\r\n}\r\n",null]}