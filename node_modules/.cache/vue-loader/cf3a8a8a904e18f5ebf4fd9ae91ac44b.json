{"remainingRequest":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Projects\\spark\\Spark.UI\\src\\views\\fbgl\\fbdwgl\\Subcontractor\\details.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Projects\\spark\\Spark.UI\\src\\views\\fbgl\\fbdwgl\\Subcontractor\\details.vue","mtime":1635844823961},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\nimport Detailsedit from '@/components/Detailsedit'\r\nimport TableEx from '@/components/TableEx'\r\nimport FlowSelect from '@/components/Flow/flowSelect'\r\nimport { GetSubcontractorDetailById, GetSubcontractorById } from '@/api/fbgl/subcontractor'\r\nimport { GetBillFlow, AddSubcontractorAssesment, PutSubcontractorAssesment } from '@/api/fbgl/subcontractorAssesment'\r\nexport default {\r\n  name: 'SubcontractorDetails',\r\n  components: {\r\n    Detailsedit,\r\n    TableEx,\r\n    FlowSelect\r\n  },\r\n  data() {\r\n    return {\r\n      size: 'mini',\r\n      addbtnLoad: false,\r\n      selectPlaceholder: '输入选择',\r\n      inputPlaceholder: '请输入',\r\n      type: 'details', // 审核:approval 详情:details 支付:pay 变更:alteration 回收:recycle, reviewStar: 评审星级\r\n      active: 1, // 提交进度 1: 编辑信息 2: 编辑审批流程\r\n      myDetails: null,\r\n      currTab: 'details',\r\n      labelWidth: 140,\r\n      firstForm: {\r\n        companyId: '',\r\n        orgId: ''\r\n      },\r\n      submitSetForm: {\r\n        id: 0,\r\n        rate: '',\r\n        remark: '',\r\n        subcontractorId: '',\r\n        state: 0,\r\n        billFlow: null\r\n      },\r\n      submitRules: {\r\n        rate: [\r\n          { required: true, message: '请选择星级', trigger: 'change' }\r\n        ]\r\n      },\r\n      table: {\r\n        columns: [\r\n          {\r\n            label: '评审编号', // 表头\r\n            minWidth: '150', // 最小宽度\r\n            prop: 'number',\r\n            class: 'link',\r\n            click: (row) => this.handleDetails(row)\r\n          },\r\n          {\r\n            label: '摘要', // 表头\r\n            minWidth: '180', // 最小宽度\r\n            prop: 'summary'\r\n          },\r\n          {\r\n            label: '状态', // 表头\r\n            minWidth: '80', // 最小宽度\r\n            prop: 'stateName'\r\n          },\r\n          {\r\n            label: '更新日期', // 表头\r\n            minWidth: '120', // 最小宽度\r\n            format: 'date',\r\n            prop: 'lastEditDate'\r\n          },\r\n          {\r\n            label: '提交人', // 表头\r\n            minWidth: '120', // 最小宽度\r\n            prop: 'submitUserName'\r\n          }\r\n        ],\r\n        list: [],\r\n        loading: false\r\n      },\r\n      htTable: {\r\n        columns: [\r\n          {\r\n            label: '评审编号', // 表头\r\n            minWidth: '150', // 最小宽度\r\n            prop: 'number'\r\n          },\r\n          {\r\n            label: '项目', // 表头\r\n            minWidth: '180', // 最小宽度\r\n            prop: 'projectName'\r\n          },\r\n          {\r\n            label: '组织机构', // 表头\r\n            minWidth: '120', // 最小宽度\r\n            prop: 'orgName'\r\n          },\r\n          {\r\n            label: '分包部位', // 表头\r\n            minWidth: '120', // 最小宽度\r\n            prop: 'subPart'\r\n          },\r\n          {\r\n            label: '合同额', // 表头\r\n            minWidth: '150', // 最小宽度\r\n            prop: 'contractAmount',\r\n            format: 'money'\r\n          }\r\n        ],\r\n        list: [],\r\n        loading: false\r\n      },\r\n      filter: {\r\n        rateList: []\r\n      }\r\n    }\r\n  },\r\n  computed: {\r\n    title() {\r\n      const { type } = this\r\n      return type === 'details' ? '星级评审记录' : '星级评审'\r\n    },\r\n    infoList() {\r\n      const {\r\n        myDetails: {\r\n          data: {\r\n            number,\r\n            orgStr,\r\n            name,\r\n            subContractorType,\r\n            address,\r\n            postAddress,\r\n            capital,\r\n            mainBusiness,\r\n            corporation,\r\n            entrustedAgent,\r\n            phone,\r\n            tel,\r\n            fax,\r\n            email,\r\n            regDate,\r\n            taxpayerType,\r\n            workerNum,\r\n            isForbidden,\r\n            bussinessType,\r\n            projectType,\r\n            businessCity,\r\n            postCertificate,\r\n            remark,\r\n            createDate,\r\n            createUserName,\r\n            currentRateDate,\r\n            lastEditUserName,\r\n            lastEditDate,\r\n            rate,\r\n            licenseUpFile,\r\n            licenseStart,\r\n            licenseEnd,\r\n            accountUpFile,\r\n            corporationUpFile,\r\n            infoUpFile,\r\n            deliveryStatementUpFile,\r\n            taxpayerCerUpFile,\r\n            qualificationUpFile,\r\n            qualificationNum,\r\n            regScopeStart,\r\n            regScopeEnd,\r\n            safetyUpFile,\r\n            safetyCerNum,\r\n            safetyPeriodStart,\r\n            safetyPeriodEnd,\r\n            financeReportUpFile,\r\n            upFile\r\n          }\r\n        }\r\n      } = this\r\n      // 数据格式化\r\n      const m = (val) => this.utils.formatMoney(val, 2, 0)\r\n      const d = (dataStr) => dataStr ? this.$moment(dataStr).format('YYYY-MM-DD') : dataStr\r\n      return [\r\n        { label: '编号', value: number },\r\n        { label: '部门', value: orgStr },\r\n        { label: '单位名称', value: name },\r\n        { label: '分包类型', value: subContractorType },\r\n        { label: '注册地址', value: address },\r\n        { label: '邮寄地址', value: postAddress },\r\n        { label: '注册资本', value: m(capital), unit: '万元' },\r\n        { label: '经营范围', value: mainBusiness },\r\n        { label: '法定代表人', value: corporation },\r\n        { label: '委托代理人', value: entrustedAgent },\r\n        { label: '手机', value: phone },\r\n        { label: '固话', value: tel },\r\n        { label: '传真', value: fax },\r\n        { label: '邮箱', value: email },\r\n        { label: '成立日期', value: d(regDate) },\r\n        { label: '纳税人性质', value: taxpayerType },\r\n        { label: '工人数量', value: workerNum },\r\n        { label: '是否禁用', value: isForbidden ? '是' : '否' },\r\n        { label: '可承接业务类型', value: bussinessType.join('、') },\r\n        { label: '可承接工程类型', value: projectType.join('、') },\r\n        { label: '可施工区域', monopolize: true, value: businessCity.join('、') },\r\n        { label: '上岗证书', value: postCertificate },\r\n        { label: '备注', value: remark },\r\n        { label: '制单人', value: createUserName },\r\n        { label: '制单时间', value: createDate },\r\n        { label: '更新人', value: lastEditUserName },\r\n        { label: '更新时间', value: lastEditDate },\r\n        { label: '星级', value: rate },\r\n        { label: '评审时间', value: currentRateDate },\r\n        { label: '营业执照', monopolize: true, component: 'UpFile', value: licenseUpFile },\r\n        { label: '营业期限', monopolize: true, value: `${d(licenseStart)} 至 ${d(licenseEnd)}` },\r\n        { label: '开户许可证', monopolize: true, component: 'UpFile', value: accountUpFile },\r\n        { label: '法定代表人身份证明', monopolize: true, component: 'UpFile', value: corporationUpFile },\r\n        { label: '分包考察资料', monopolize: true, component: 'UpFile', value: infoUpFile },\r\n        { label: '送达声明', monopolize: true, component: 'UpFile', value: deliveryStatementUpFile },\r\n        { label: '纳税人信息证明', monopolize: true, component: 'UpFile', value: taxpayerCerUpFile },\r\n        { label: '施工资质证书  ', monopolize: true, component: 'UpFile', value: qualificationUpFile },\r\n        { label: '编号', value: qualificationNum },\r\n        { label: '登记范围', value: `${regScopeStart}${regScopeEnd}` },\r\n        { label: '安全生产许可证', monopolize: true, component: 'UpFile', value: safetyUpFile },\r\n        { label: '编号', value: safetyCerNum },\r\n        { label: '有效期', value: `${d(safetyPeriodStart) || ''} 至 ${d(safetyPeriodEnd) || ''}` },\r\n        { label: '财务审计报告', monopolize: true, component: 'UpFile', value: financeReportUpFile },\r\n        { label: '其他附件', monopolize: true, component: 'UpFile', value: upFile }\r\n      ]\r\n    }\r\n  },\r\n  beforeRouteEnter(to, from, next) {\r\n    next(vm => {\r\n      vm.initData()\r\n    })\r\n  },\r\n  methods: {\r\n    /**\r\n     * @description: 初始化数据\r\n     */\r\n    initData() {\r\n      const { id, type, subcontractorAssesmentId } = this.$route.query\r\n      this.myId = id\r\n      this.active = 1\r\n      this.currTab = 'details'\r\n      this.submitSetForm.subcontractorId = Number(id)\r\n      this.submitSetForm.id = Number(subcontractorAssesmentId) || 0\r\n      this.type = type\r\n      const rateList = this.$route.query.rateList ? JSON.parse(this.$route.query.rateList) : []\r\n      this.filter.rateList = rateList\r\n      this.fetchData()\r\n    },\r\n    /**\r\n     * 获取详情信息\r\n     */\r\n    async fetchData() {\r\n      if (!this.myId) return\r\n      GetSubcontractorDetailById({ id: this.myId }).then(res => {\r\n        this.myDetails = res\r\n        this.htTable.list = res.subcontractList\r\n        this.table.list = res.data.subcontractorAssesment\r\n        if (res.data.rate === '不合格') {\r\n          this.filter.rateList.forEach(el => {\r\n            if (el.name !== '合格') {\r\n              el.disabled = true\r\n            }\r\n          })\r\n        }\r\n      })\r\n      GetSubcontractorById({ id: this.myId }).then(res => {\r\n        const form = this.firstForm\r\n        for (const key in form) {\r\n          if (Object.hasOwnProperty.call(form, key)) {\r\n            form[key] = res.data[key] || form[key]\r\n          }\r\n        }\r\n      })\r\n    },\r\n    /*\r\n     *下一步\r\n     */\r\n    nextStep(formName) {\r\n      this.$refs[formName].validate(valid => {\r\n        if (valid) {\r\n          this.getBillFlow()\r\n        }\r\n      })\r\n    },\r\n    getBillFlow() {\r\n      // 获取流程数据\r\n      const { state, billFlow } = this.submitSetForm\r\n      const req = {\r\n        ...this.firstForm,\r\n        ...this.submitSetForm,\r\n        state: state || 0\r\n      }\r\n      if (billFlow) req.billFlowId = billFlow.id\r\n      delete req.billFlow\r\n      GetBillFlow(req).then(({ data, success, message }) => {\r\n        if (success) {\r\n          this.submitSetForm.billFlow = data.billFlow\r\n          this.setActive(2)\r\n        } else {\r\n          this.$message.error(message)\r\n        }\r\n      })\r\n    },\r\n    /**\r\n     * 修改填报进度\r\n     */\r\n    setActive(active) {\r\n      this.active = active\r\n    },\r\n    /**\r\n     * 提交表单\r\n     * @param {Number} state 提交类型，0：保存；1：提交; 10000: 修改\r\n     */\r\n    submitForm(state) {\r\n      const req = {\r\n        ...this.firstForm,\r\n        ...this.submitSetForm,\r\n        state\r\n      }\r\n      if (this.submitSetForm.billFlow) {\r\n        // 获取流程组件中的数据\r\n        const billFlow = this.$refs.flowSelect.getBillFlow()\r\n        if (!billFlow) {\r\n          return false\r\n        }\r\n        req.billFlow = billFlow\r\n      } else {\r\n        this.$message.error('流程数据不能为空')\r\n        return\r\n      }\r\n      if (req.id) {\r\n        PutSubcontractorAssesment(req).then(res => {\r\n          // 更新\r\n          this.$message.success('保存成功')\r\n          this.back('SubcontractorIndex')\r\n        })\r\n      } else {\r\n        this.addbtnLoad = true\r\n        AddSubcontractorAssesment(req).then(() => {\r\n          // 添加\r\n          this.$message.success('提交成功')\r\n          this.back('SubcontractorIndex')\r\n        }).finally(() => {\r\n          this.addbtnLoad = false\r\n        }).catch(() => {\r\n          this.addbtnLoad = false\r\n        })\r\n      }\r\n    },\r\n    /**\r\n     * 返回上一页，并关闭当前页\r\n     */\r\n    back(refreshRouterName) {\r\n      // this.utils.closeAndRefresh(this.$route.query.refreshRouterName)\r\n      this.utils.closeAndRefresh(refreshRouterName)\r\n    },\r\n    /**\r\n     * @description: 跳转到对应的评审页面\r\n    */\r\n    handleDetails(row, type = 'details') {\r\n      this.$router.push({ name: 'SubcontractorAssesmentDetails', query: { type, id: row.id, refreshRouterName: this.$route.name }})\r\n    }\r\n  }\r\n}\r\n",null]}