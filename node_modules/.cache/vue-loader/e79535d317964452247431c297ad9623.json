{"remainingRequest":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\Projects\\spark\\Spark.UI\\src\\views\\cggl\\swcb\\businessCostDetailAdd.vue?vue&type=script&lang=js&","dependencies":[{"path":"D:\\Projects\\spark\\Spark.UI\\src\\views\\cggl\\swcb\\businessCostDetailAdd.vue","mtime":1634539861955},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\babel-loader\\lib\\index.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\Projects\\spark\\Spark.UI\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":["//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n//\n\r\nimport { getAllMaterialCategory } from '@/api/cggl/material'\r\nimport { getTree } from '@/utils/index'\r\nimport { validate } from '@/utils/validate'\r\nexport default {\r\n  name: 'BusinessCostDetailAdd',\r\n  components: {\r\n  },\r\n  props: {\r\n    obj: {\r\n      type: Object,\r\n      default: null\r\n    }\r\n  },\r\n  data() {\r\n    return {\r\n      ruleForm: {\r\n        materialCategoryId: null,\r\n        materialCategory: null,\r\n        quantity: null,\r\n        price: null,\r\n        amount: null,\r\n        remark: ''\r\n\r\n        // confirmTime: null,\r\n        // processOrgId: null,\r\n        // processUser: null,\r\n        // enteredQuantity: null\r\n      },\r\n      buttonLoading: false,\r\n      comName: '',\r\n      list: null,\r\n      categoryList: null,\r\n      // categoryPropertyList: null,\r\n      oldrProperty: {},\r\n      options: null,\r\n      rules: {\r\n        materialCategoryId: [{ required: true, message: '请选择', trigger: 'change' }],\r\n        quantity: [{ validator: validate.logic, logic: value => value >= 0, required: true, trigger: 'blur' }],\r\n        price: [{ validator: validate.logic, logic: value => value >= 0, required: true, trigger: 'blur' }]\r\n        // amount: [{ validator: validate.logic, logic: value => value >= 0, required: true, trigger: 'blur' }]\r\n      }\r\n    }\r\n  },\r\n  computed: {\r\n    getEndCategoryId() { // 获取categoryId数 组中最后一个 id\r\n      return this.ruleForm.materialCategoryId[this.ruleForm.materialCategoryId.length - 1]\r\n    }\r\n  },\r\n  watch: {\r\n    'ruleForm.quantity': {\r\n      handler: function(value) {\r\n        this.ruleForm.amount = this.ruleForm.price * value\r\n      },\r\n      immediate: true\r\n    },\r\n    'ruleForm.price': {\r\n      handler: function(value) {\r\n        this.ruleForm.amount = this.ruleForm.quantity * value\r\n      },\r\n      immediate: true\r\n    }\r\n  },\r\n  created() {},\r\n  mounted() {\r\n    this.initData()\r\n  },\r\n  methods: {\r\n    submitForm(formName) {\r\n      this.$refs[formName].validate(valid => {\r\n        if (valid) {\r\n          var newObj = JSON.parse(JSON.stringify(this.ruleForm))\r\n          // 获取级联数组中的最后一个id,就是当前选中的最末级的分类id\r\n          var computerCategoryId = newObj.materialCategoryId[newObj.materialCategoryId.length - 1]\r\n          newObj.category = this.categoryList.find(f => f.id === computerCategoryId)\r\n          newObj.materialCategoryId = computerCategoryId\r\n          if (newObj.materialCategory.level !== 3) {\r\n            this.$message.error('选择的材料必须是三级分类')\r\n            return false\r\n          }\r\n          // console.log('提交的数据：', newObj)\r\n          if (this.obj) {\r\n            this.$emit('dialogClose', newObj, 'update')\r\n          } else {\r\n            this.$emit('dialogClose', newObj, 'add')\r\n          }\r\n        }\r\n      })\r\n    },\r\n    initData() {\r\n      const promise = this.getCategory()\r\n      if (this.obj) {\r\n        promise.then(() => {\r\n          var newObj = JSON.parse(JSON.stringify(this.obj))\r\n          // console.log('newObj:', newObj)\r\n          this.ruleForm = newObj\r\n          // 拼接id成三级数组，来匹配 选材料 级联菜单\r\n          var categoryIdArray = []\r\n          var secondCategoryId = this.categoryList.find(f => f.id === this.ruleForm.materialCategoryId).pid\r\n          var firstCategoryId = this.categoryList.find(f => f.id === secondCategoryId).pid\r\n          categoryIdArray.push(firstCategoryId)\r\n          categoryIdArray.push(secondCategoryId)\r\n          categoryIdArray.push(this.ruleForm.materialCategoryId)\r\n          this.ruleForm.materialCategoryId = categoryIdArray\r\n        })\r\n      }\r\n    },\r\n    getCategoryInfo() {\r\n      // 材料级联，最后一个id 才是选中的id\r\n      var computerCategoryId = this.ruleForm.materialCategoryId[this.ruleForm.materialCategoryId.length - 1]\r\n      this.ruleForm.materialCategory = this.categoryList.find(f => f.id === computerCategoryId)\r\n      // console.log(this.ruleForm.materialCategory)\r\n    },\r\n    getCategory(query) {\r\n      const pro1 = new Promise((resolve, reject) => {\r\n        getAllMaterialCategory({ name: query }).then(response => {\r\n          const { data } = response\r\n          data.forEach(e => {\r\n            e.pid = e.pId\r\n            e.label = e.name\r\n            e.value = e.id\r\n            delete e.pId\r\n          })\r\n          this.categoryList = data\r\n          this.options = getTree(0, data)\r\n          resolve()\r\n        }).catch(() => { reject() })\r\n      })\r\n      return pro1\r\n      // }\r\n    }\r\n\r\n  }\r\n}\r\n",null]}